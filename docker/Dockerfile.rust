# Rust 构建镜像
FROM rust:latest as builder

# 安装依赖
RUN apt-get update && apt-get install -y \
    pkg-config \
    libzmq3-dev \
    libssl-dev \
    protobuf-compiler \
    && rm -rf /var/lib/apt/lists/*

# 使用 nightly Rust
RUN rustup default nightly

WORKDIR /build

# 复制 Cargo 文件
COPY rust/Cargo.toml rust/Cargo.toml
COPY rust/common/Cargo.toml rust/common/Cargo.toml
COPY rust/common/build.rs rust/common/build.rs
COPY rust/common/proto/ rust/common/proto/
COPY rust/market-data/Cargo.toml rust/market-data/Cargo.toml
COPY rust/gateway/Cargo.toml rust/gateway/Cargo.toml

# 创建虚拟源文件以缓存依赖
RUN mkdir -p rust/common/src rust/market-data/src rust/gateway/src && \
    echo "fn main() {}" > rust/market-data/src/main.rs && \
    echo "fn main() {}" > rust/gateway/src/main.rs && \
    echo "pub fn dummy() {}" > rust/common/src/lib.rs

# 构建依赖（缓存层）
RUN cd rust && cargo build --release || true

# 复制实际源代码
COPY rust/ rust/

# 构建实际程序
RUN cd rust && cargo build --release

# 运行时镜像
FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y \
    libzmq5 \
    ca-certificates \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 从构建镜像复制二进制文件
COPY --from=builder /build/rust/target/release/market-data /app/market-data
COPY --from=builder /build/rust/target/release/gateway /app/gateway

# 复制配置文件
COPY config/ /app/config/

# 健康检查端点（TODO: 实现）
HEALTHCHECK --interval=10s --timeout=3s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# 使用环境变量决定运行哪个服务
CMD if [ "$MARKET" != "" ]; then /app/market-data; else /app/gateway; fi
